
TIME_INTERVAL = 0.5;
WC_DEED_TIER_01 = 160431;
WC_DEED_TIER_02 = 164148;

WC_STRUCTURE_TIER_01 = 160432;
WC_STRUCTURE_TIER_02 = 164147;

MaximumAtticCount = 500;

FURNITURE_LIST = {
   160796,160802,160803,160804,160805,160806,160807,160808,160809,160810,160811,160812,160813,160814,160819,
   160818,160815,160816,160817,160820,160821,160822,160823,160824,160826,160825,160827,160828,160829,160830,160831,
   160832,160833,160834,160835,160836,160837,160838,160839,160840,160841,160842,160843,160844,160845,160846,160847,
   160848,160849,160850,160851,160852,160853,160854,160855,160856,160857,160858,160859,160860,160861,160862,160863,
   160864,160865,160866,160867,160868,160869,160870,160871,160798,160874,82705,82706,82707,82708,82709,82710,82711,
   82712,82713,82714,82715,82716,82717,82718,82719,82720,82721,82722,82723,82724,82725,82726,82727,82728,82729,82755,
   82754,82753,82752,82751,82740,82750,82749,82748,82747,82746,82745,82744,82743,82742,82756,82741,82739,82737,
   82758,82738,82736,82735,82730,82731,82732,82733,82734,82757,82771,82778,82777,82776,82775,82774,82773,82772,
   82770,82769,82767,82768,82766,82765,82764,82763,82762,82761,82760,82759,82779,82780,82781,82823,82826,82836,
   82825,82835,82834,82782,82783,82784,82785,82811,82814,82832,82848,82847,82846,82845,82844,82843,82842,82841,
   82840,82839,82838,82907,82908,82833,82837,82824,82831,82830,82829,82828,82827,82822,82849,82851,82854,82857,
   82860,82866,82865,82864,82863,82862,82861,82859,82858,82856,82855,82853,82868,82867,82852,82850,82869,82872,
   82874,82879,82883,82885,82891,82893,82892,82890,82889,82888,82887,82886,82884,82882,82881,82880,82878,82877,
   82876,82875,82873,82871,82870,82895,82897,82898,82896,82899,82902,82903,82906,82905,82904,82901,82900,160645,
   160646,160647,160648,160649,160650,160651,160652,160653,160654,160655,160656,160657,160658,160659,160668,160660,
   160661,160662,160663,160664,160665,160666,160667,160669,160670,160671,160672,160673,160615,160674,160675,160676,
   160677,160678,160679,160680,160681,160682,160683,160684,160685,160686,160687,160688,160689,160690,160691,160692,
   160693,160694,160695,160696,160697,160698,160699,160700,160701,160702,160703,160704,160705,160706,160707,160708,
   160709,160710,160711,160712,160713,160714,160617,160619,160618,160756,160757,160758,160759,160760,160761,160762,
   160763,160764,160765,160766,160767,160768,160769,160770,160771,160772,160773,160774,160775,160776,160777,160778,
   160779,160780,160781,160782,160783,160436,160520,160521,160522,160523,160524,160525,160526,160527,160437,160528,
   160529,160530,160531,160532,160533,160534,160535,160536,160537,160538,160539,160540,160541,160542,160543,160544,
   160545,160546,160547,160548,160549,160550,160551,160552,160553,160554,160555,160556,160557,160558,160559,160560,
   160561,160562,160563,160564,160565,160566,160567,160568,160569,160570,160571,160572,160573,160574,160575,160576,
   160577,160578,160579,160580,160581,160582,160583,160584,160585,160586,160439,160595,160603,160604,160605,160606,
   160607,160608,160596,160597,160598,160599,160600,160601,160602,160609,160610,160611,160612,160613,160440,160587,
   160588,160589,160590,160591,160592,160593,160594,160200,160201,160202,160203,160204,160205,160206,160207,160208,
   160209,160210,160214,160226,160228,160227,160225,160222,160223,160221,160220,160219,160218,160217,160216,160215,
   160213,160212,160211,160229,160230,160231,160232,160233,160234,160235,160236,160237,160238,160239,160240,160241,
   160242,160243,160244,160245,160246,160247,160248,160249,160250,160251,160252,160253,160254,160255,160256,160257,
   160258,160259,160260,160261,160262,160263,160264,160265,160199,160266,160270,160271,160267,160268,160269,160272,
   160273,160274,160275,160276,160277,160278,160279,160280,160281,160282,160283,160284,160285,160286,160287,160288,
   160289,160290,160291,160292,160293,160294,160295,160296,160297,160298,160299,160300,160301,160302,160303,160310,
   160311,160312,160313,160314,160315,160316,160317,160318,160319,160320,160321,160322,160323,160324,160325,160326,
   160327,160328,160329,160330,160331,160332,160333,160334,160335,160336,160337,160338,160339,160340,160341,160342,
   160343,160344,160345,160346,160347,160348,160349,160350,160351,160352,160353,160354,160355,160356,160357,160358,
   160359,160360,160361,160362,160363,160364,160365,160366,160367,160368,160369,160370,160371,160372,160373,160374,
   160375,160376,160377,160378,160379,160380,160381,160382,160383,160384,160385,160386,160387,160388,160389,160390,
   160391,160392,160393,160394,160395,160396,160397,160398,160399,160400,160401,160402,160403,160404,160405,160406,
   160407,160408,160409,160410,160411,160412,160413,160414,160415,160416,160417,160418,160419,160420,160421,160422,
   160423,160424,160425,160426,160427,246978852,153085,161017,161016,161015,
   82937,161013,161012,161011,161010,161009,161008,161007,161006,82910,82911,161005,161004,160799,160875,160876,
   160877,160878,160879,160880,160881,160882,160883,160884,160885,160900,160901,160886,160902,160887,160888,
   160889,160903,160904,160890,160891,160892,160893,160905,160897,160898,160899,160894,160895,160896,160800,
   160906,160907,160908,160909,82912,82913,82914,160801,160910,160912,160913,160914,160915,160916,160917,160918,
   160919,160920,160921,160922,160923,160986,160987,160988,160989,160990,160991,160992,160993,160994,160614,160620,
   160621,160622,160623,160624,160625,160626,160627,160628,160629,160630,160631,160632,160633,160634,160635,160636,
   160637,160638,160639,160640,160641,160642,160643,160644,160995,82941,82942,82943,160996,160997,160998,160616,
   160719,160720,160716,160717,160718,160721,160722,160723,160724,160725,160726,160727,160728,160729,160730,160731,
   160732,160733,160734,160735,160736,160737,160738,160739,160740,160741,160742,160743,160744,160745,160746,160747,
   160748,160435,160441,160442,160443,160444,160445,160446,160447,160448,160449,160450,160451,160452,160453,160454,
   160455,160456,160457,160458,160459,160460,160461,160462,160463,160464,160467,160465,160466,160468,160469,160470,
   160471,160472,160473,160474,160475,160476,160477,160478,160479,160480,160481,160482,160483,160484,160485,160486,
   160487,160488,160489,160490,160491,160492,160493,160494,160495,160496,160497,160498,160499,160500,160501,160502,
   160503,160505,160506,160507,160508,160509,160510,160511,160512,160513,160514,160515,160516,160517,160518,82918,
   82933,82920,82922,82921,82944,82945,82946,82923,82924,82947,82925,82926,82927,82917,82916,82915,
   160966,160967,160968,160969,160970,160971,160972,160973,160974,160975,82958,82957,82956,82955,82954,82953,
   82952,82951,82950,82949,82948,82936,160976,160977,160978,160979,160980,160981,160982,160983,160984,160985,
   82959,
};

startPos = {};
addingItems = true;

targetDeed = 0;

-- helper function to setup callbacks and register the event
function AddEvent(eventName, eventFunc)
	event_args = {};
	event_args.LUA_CallBack = eventFunc;
	RegisterEvent( eventName, event_args );	
end

function SwitchLots()
--
   local templateID = GetEquippedDeedID();
   if (templateID == WC_DEED_TIER_01) then
   --
      if (HasInventoryItem(WC_DEED_TIER_02) == 0) then
      --
         Log("Giving player WC_DEED_TIER_02");
         CreateTestIsland(WC_DEED_TIER_02, WC_STRUCTURE_TIER_02);
         Sleep(10);
      --
      end
      Log("Equipping WC_DEED_TIER_02");
      EquipItem(WC_STRUCTURE_TIER_02, "Structure");
      EquipItem(WC_DEED_TIER_02, "Islands");
      
      targetDeed = WC_DEED_TIER_02;
   --
   else
   --
      Log("Equipping WC_DEED_TIER_01");
      EquipItem(WC_STRUCTURE_TIER_01, "Structure");
      EquipItem(WC_DEED_TIER_01, "Islands");
      
      targetDeed = WC_DEED_TIER_01;
   --
   end
--
end

function OnTimer()
--
   if (targetDeed ~= 0) then
   --
      local templateID = GetEquippedDeedID();
      if (templateID == targetDeed) then
      --
         targetDeed = 0;
         GotoHousingLot();
      --
      end
   elseif (IsHousingLot() == 1) then
   --
      local limit = GetHousingItemLimit();
      local current = CountHousingItems();
      Log("limit = "..limit.." current = "..current);
      if (current == 0) then
      --
         addingItems = true;
         if (math.random(100) > 50) then
         --
            SwitchLots();
         --
         end
      --
      end
      
      if (addingItems == true) then
      --
         if (current >= limit) then
         --
            if (math.random(100) > 50) then
            --
               addingItems = false;
               
               local atticCount = GetAtticItemCount();
               if (atticCount < MaximumAtticCount) then
               --
                  SwitchLots();
               --
               end
            --
            end
         --
         else
         --
            local objectGID = GetFirstFurnitureItem();
            if (objectGID ~= "GID:0") then
            --
               startPos[1], startPos[2], startPos[3], startPos[4] = GetPlayerPosition();
               
               local x = math.random(1200) - 600;
               local y = math.random(1200) - 600;
               local z = math.random(200) + startPos[3];
               local yaw = math.random(4) - 1;
               if (yaw == 3) then
               --
                  yaw = 4.71;
               --
               elseif (yaw == 2) then
               --
                  yaw = 3.14;
               --
               elseif (yaw == 1) then
               --
                  yaw = 1.57;
               --
               else
               --
                  yaw = 0;
               --
               end      
               
               PlaceFurnitureItem(objectGID, x, y, z, yaw);
            --
            else
            --
               local objectID = FURNITURE_LIST[math.random(#FURNITURE_LIST)];
               Server("AddInventory", objectID);
               Log("Adding item "..objectID);
            --
            end
         --
         end
      --
      else
      --
         local count = math.random(current) - 1;
         local objectGID = GetPlacedHousingItem(count);
         if (objectGID == "GID:0") then
         --
            addingItems = true;
         --
         else
         --
            PickupFurnitureItem(objectGID);
         --
         end
      ---
      end
   --
   end
--
end

function Start()
   OnTimer();
	StartTimer("MonkeyTimer", TIME_INTERVAL, false);
end

function CharacterCreated()
   UnregisterEvent("CharacterSelectState");
   
	--For some odd reason, trying to select a character too soon after getting the
	--CharacterSelectState event doesn't work.  So, I'm waiting a bit.
	Sleep(5);

   local success = nil;
   success = SelectFirstCharacter();

   if (success == 0) then
      Log("Problem creating character; ending script process.");
      Kill(GetProcessID());
   end
end

function CharacterHandling()
   local success = nil;
   success = SelectFirstCharacter();
   
   --If successful then we'll get the message we teleported when in the game
   if (success == 0) then
      AddEvent("CharacterSelectState", CharacterCreated);
      WizCreateCharacter(1);
   end
end

function Init()
   startPos[1], startPos[2], startPos[3], startPos[4] = GetPlayerPosition();
   
   if (startPos[1] and startPos[2] and startPos[3] and startPos[4]) then
      Log("Player starting position: "..startPos[1]..", "..startPos[2]..", "..startPos[3]..", "..startPos[4]);
   end
   
   if (GetCharacterGID() == 0) then
      CharacterHandling();
      
      while(GetCharacterGID() == 0) do
      --
         Log("Waiting for player...");
         Sleep(2);
         SelectFirstCharacter();
      --
      end

   end
   
   Server("SetLevel", 50);
   
   local templateID = GetEquippedDeedID();
   if (templateID ~= WC_DEED_TIER_01) then
   --
      if (HasInventoryItem(WC_DEED_TIER_01) == 0) then
      --
         Log("Giving player WC_DEED_TIER_01");
         CreateTestIsland(WC_DEED_TIER_01, WC_STRUCTURE_TIER_01);
         Sleep(3);
      --
      end
      Log("Equipping WC_DEED_TIER_01");
      EquipItem(WC_STRUCTURE_TIER_01, "Structure");
      EquipItem(WC_DEED_TIER_01, "Islands");

      Sleep(3);
   --
   end
   
   if (IsHousingLot() == 1) then
   --
      GotoCommons();
      Sleep(3);
   --
   end
   
   targetDeed = WC_DEED_TIER_01;
   
	AddEvent("MonkeyTimer", OnTimer);
   Start();
end

function main()	
	Log("Housing Test Script Starting");
	-- seed random and pop a few randoms off (docs say this ensures a "more" random first number...dont ask me	
	math.randomseed(GetTime());
	math.random();
	math.random();
	math.random();
	math.random();

   Init();

	while(true) do 
		-- GetEvent called with no parameters = get any event and no timeout
		event = GetEvent();
		if(event) then
         Log(event.EventName);
			-- since all of our registered events have a callback, 
			-- we will not have to handle event parsing within our main()
			if (event.LUA_CallBack) then
				event.LUA_CallBack(event);
			end
		end
	end
	Log("Ending Housing Test Script");
end

